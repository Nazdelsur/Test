<!DOCTYPE html>
<html lang="en">

<head>
    <title>HIBERION Web Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

    <!-- Scripts -->
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Styles embebidos con glassmorfismo -->
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(180deg, rgba(179, 179, 179, 0.62), rgba(111, 109, 109, 0.2)),
                        url('./img/MS-YP-wallpaper-desktop-1.png') no-repeat center center / cover;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chatwindow {
            width: 90%;
            max-width: 900px;
            height: 90vh;
            backdrop-filter: blur(12px) brightness(100%);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            box-shadow: inset 0 0 22px rgba(242, 242, 242, 0.5),
                        inset 2px 2px 1px -2px rgba(179, 179, 179, 1),
                        inset -5px -12px 6px -14px rgba(179, 179, 179, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #header {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-weight: 700;
            font-size: 22px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        #subheader {
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            padding: 10px 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #login, #logout {
            background: rgba(119, 134, 217, 0.6);
            color: white;
            font-weight: 500;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #login:hover, #logout:hover {
            background: rgba(119, 134, 217, 0.9);
        }

        #webchat {
            flex: 1;
        }
    </style>
</head>

<body>
    <div id="chatwindow">
        <div id="header">
            <img src="igris_bot_icon_128x128.png" alt="HIBERION LOGO" style="height: 40px; margin-right: 10px;">
            HIBERION Chat Web
        </div>
        <div id="subheader">
            <span id="loginStatus">You are not logged in on the website.</span>
            <div>
                <button id="login" onclick="onSignInClick()">Log in</button>
                <button id="logout" onclick="onSignOutClick()" style="display:none">Log out</button>
            </div>
        </div>
        <div id="webchat"></div>
    </div>

    <script>
        const clientId = "4b2315fa-fd7b-4bcf-9ea0-283a5b877e11";
        const tenantId = "959d9200-12be-4937-9ff4-a42df3cd2427";
        const tokenEndpoint = "https://2e3fb5a32998ed9fad7d8ee9e845db.49.environment.api.powerplatform.com/powervirtualagents/botsbyschema/iaghm_iagEmploymentHistoryReader/directline/token?api-version=2022-03-01-preview";

        const msalConfig = {
            auth: {
                clientId: clientId,
                authority: `https://login.microsoftonline.com/${tenantId}`
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            scopes: ["User.Read", "openid", "profile"]
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        async function onSignInClick() {
            try {
                await msalInstance.loginPopup(loginRequest);
            } catch (err) {
                console.error(err);
            }
            handleUserState();
            await renderChatWidget();
        }

        async function onSignOutClick() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                await msalInstance.logoutPopup({ account: accounts[0] });
                location.reload();
            }
        }

        function handleUserState() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                const user = accounts[0];
                document.getElementById("loginStatus").textContent = `Currently logged in as ${user.name} on the website.`;
                document.getElementById("login").style.display = "none";
                document.getElementById("logout").style.display = "inline-block";
            }
        }

        handleUserState();

        async function fetchJSON(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: { ...options.headers, accept: 'application/json' }
            });
            if (!res.ok) throw new Error(`Fetch failed with status ${res.status}`);
            return await res.json();
        }

        async function renderChatWidget() {
            const accounts = msalInstance.getAllAccounts();
            const user = accounts[0];
            const userID = user?.localAccountId ?? Math.random().toString(36).substr(2, 15);

            const { token } = await fetchJSON(tokenEndpoint);
            const directLine = window.WebChat.createDirectLine({ token });

            const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
                if (action.type === "DIRECT_LINE/CONNECT_FULFILLED") {
                    dispatch({
                        type: "DIRECT_LINE/POST_ACTIVITY",
                        payload: {
                            activity: {
                                type: "event",
                                name: "startConversation",
                                channelData: { postBack: true }
                            }
                        }
                    });
                }
                return next(action);
            });

            const styleOptions = {
                botAvatarImage: 'igris_bot_icon_128x128.png',
                botAvatarBackgroundColor: 'transparent',
                userAvatarBackgroundColor: 'transparent',
                bubbleBackground: 'rgba(255,255,255,0.2)',
                bubbleBorderRadius: 16,
                bubbleFromUserBackground: 'rgba(102,102,102,0.2)',
                bubbleFromUserBorderRadius: 16,
                sendBoxBackground: 'rgba(255,255,255,0.2)',
                sendBoxTextColor: '#000',
                primaryFont: "'Montserrat', sans-serif",
                accent: '#7786D9'
            };

            window.WebChat.renderWebChat({
                directLine,
                store,
                userID,
                styleOptions
            }, document.getElementById('webchat'));
        }

        (async () => {
            await renderChatWidget();
        })();
    </script>
</body>
</html>
