<!DOCTYPE html>
<html lang="en">

<head>
  <title>HIBERUS Web Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Barlow&display=swap" rel="stylesheet">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Barlow', sans-serif;
      background: linear-gradient(135deg, #1e90ff, #6a11cb);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .chat-container {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      width: 90%;
      max-width: 1200px;
      height: 80vh;
      display: flex;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .chat-box {
      flex: 2;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #webchat {
      flex-grow: 1;
    }

    .chat-header {
      font-size: 28px;
      font-weight: bold;
      color: #fff;
      margin-bottom: 10px;
    }

    .bot-avatar {
      flex: 1;
      background: url('igris_bot_icon_128x128.png') center/contain no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-box">
      <div class="chat-header">How can I help you today?</div>
      <div id="webchat"></div>
    </div>
    <div class="bot-avatar"></div>
  </div>

  <script>
    const clientId = "4b2315fa-fd7b-4bcf-9ea0-283a5b877e11";
    const tenantId = "959d9200-12be-4937-9ff4-a42df3cd2427";
    const tokenEndpoint = "https://2e3fb5a32998ed9fad7d8ee9e845db.49.environment.api.powerplatform.com/powervirtualagents/botsbyschema/iaghm_iagEmploymentHistoryReader/directline/token?api-version=2022-03-01-preview";

    const msalConfig = {
      auth: {
        clientId,
        authority: `https://login.microsoftonline.com/${tenantId}`
      },
      cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false
      }
    };

    const loginRequest = {
      scopes: ["User.Read", "openid", "profile"]
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function exchangeTokenAsync(resourceUri) {
      const user = msalInstance.getAllAccounts();
      if (user.length <= 0) return null;

      try {
        const tokenResponse = await msalInstance.acquireTokenSilent({ scopes: [resourceUri] });
        return tokenResponse.accessToken;
      } catch (err) {
        console.log(err);
        return null;
      }
    }

    function getOAuthCardResourceUri(activity) {
      return activity?.attachments?.[0]?.content?.tokenExchangeResource?.uri || null;
    }

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          accept: 'application/json'
        }
      });
      if (!res.ok) throw new Error(`Failed to fetch JSON due to ${res.status}`);
      return await res.json();
    }

    async function renderChatWidget() {
      const accounts = msalInstance.getAllAccounts();
      const user = accounts.length > 0 ? accounts[0] : null;
      const userID = user?.localAccountId?.substring(0, 36) || (Math.random().toString() + Date.now().toString()).substring(0, 64);

      const { token } = await fetchJSON(tokenEndpoint);
      const directLine = window.WebChat.createDirectLine({ token });

      const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
        if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
          dispatch({
            type: 'DIRECT_LINE/POST_ACTIVITY',
            meta: { method: 'keyboard' },
            payload: {
              activity: {
                type: 'event',
                name: 'startConversation',
                channelData: { postBack: true }
              }
            }
          });
        }

        if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
          const activity = action.payload.activity;
          const isOAuthCard = activity.attachments?.[0]?.contentType === 'application/vnd.microsoft.card.oauth';

          if (isOAuthCard) {
            const resourceUri = getOAuthCardResourceUri(activity);
            if (user && resourceUri) {
              exchangeTokenAsync(resourceUri).then(token => {
                if (token) {
                  directLine.postActivity({
                    type: 'invoke',
                    name: 'signin/tokenExchange',
                    value: {
                      id: activity.attachments[0].content.tokenExchangeResource.id,
                      connectionName: activity.attachments[0].content.connectionName,
                      token
                    },
                    from: { id: userID, name: user.name || 'user', role: 'user' }
                  }).subscribe();
                }
              });
            }
            return;
          }
        }

        return next(action);
      });

      const styleOptions = {
        botAvatarImage: 'igris_bot_icon_128x128.png',
        userAvatarImage: 'Icon_mini.png',
        bubbleBackground: 'rgba(255,255,255,0.3)',
        bubbleFromUserBackground: 'rgba(0,0,0,0.1)',
        bubbleBorderRadius: 12,
        sendBoxBackground: '#ffffffaa',
        sendBoxBorderTop: '2px solid #ccc',
        sendBoxTextColor: '#000',
        primaryFont: 'Barlow, sans-serif',
        accent: '#ffffff'
      };

      const activityMiddleware = () => next => card => {
        if (card.activity.from.role === 'user') {
          card.activity.from = { id: userID, name: 'User', role: 'user' };
        }
        return next(card);
      };

      window.WebChat.renderWebChat({
        directLine,
        store,
        styleOptions,
        userID,
        user: { id: userID, name: 'User', role: 'user' },
        activityMiddleware
      }, document.getElementById('webchat'));
    }

    (async () => {
      await renderChatWidget();
    })();
  </script>
</body>

</html>
